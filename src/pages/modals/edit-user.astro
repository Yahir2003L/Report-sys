---
import EditUserModal from '@/components/EditUserModal.astro';
import { getUserFromToken } from '@/lib/auth';
import { pool } from '@/lib/db';
import { isSuperadmin } from '@/lib/access-control';
import type { RowDataPacket } from 'mysql2';

const token = Astro.cookies.get('session_token')?.value;
const currentUser = await getUserFromToken(token || "");

if (!currentUser || !isSuperadmin(currentUser)) {
  return new Response('Unauthorized', { status: 401 });
}

const userId = Astro.url.searchParams.get("id");

if (!userId) {
  return new Response('ID de usuario faltante', { status: 400 });
}

const [rows] = await pool.query<RowDataPacket[]>(`SELECT * FROM users WHERE id = ?`, [userId]);

if (rows.length === 0) {
  return new Response('Usuario no encontrado', { status: 404 });
}

const user = rows[0];
---

<EditUserModal user={user} />
