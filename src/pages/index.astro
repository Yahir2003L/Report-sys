---
import Report from '@/components/icons/Report.astro';
import Layout from '../layouts/Layout.astro';
import { getUserFromToken } from '../lib/auth';
import { ClientRouter } from 'astro:transitions';
import Clock from '@/components/icons/Clock.astro';
import Check from '@/components/icons/Check.astro';

interface Report {
  id: number;
  classroom: string;
  problem_type: 'red' | 'telefonico' | 'proyector' | 'pantalla' | 'electrico' | 'general';
  priority: 'alta' | 'media' | 'baja';
  description: string;
  status: 'pendiente' | 'en_proceso' | 'resuelto'; 
  sector: 'primaria' | 'secundaria' | 'bachillerato' | 'universidad';
  created_at: string;
  created_by: number;
  created_by_name: string;
}

interface Stats {
  total: number;
  pendientes: number;
  resueltos: number;
  bySector: {
    primaria: number;
    secundaria: number;
    bachillerato: number;
    universidad: number;
  };
  byStatus: {
    pendiente: number;
    en_proceso: number;
    resuelto: number;
  };
  byPriority: {
    alta: number;
    media: number;
    baja: number;
  };
}

const token = Astro.cookies.get('session_token')?.value;
const user = token ? await getUserFromToken(token) : null;

if (!user) {
  return Astro.redirect('/login');
}

// Obtener estadísticas del dashboard
let reports: Report[] = [];
let stats: Stats = {
  total: 0,
  pendientes: 0,
  resueltos: 0,
  bySector: {
    primaria: 0,
    secundaria: 0,
    bachillerato: 0,
    universidad: 0
  },
  byStatus: {
    pendiente: 0,
    en_proceso: 0,
    resuelto: 0
  },
  byPriority: {
    alta: 0,
    media: 0,
    baja: 0
  }
};

try {
  const apiUrl = Astro.url.origin + '/api/reports';
  const response = await fetch(apiUrl, {
    headers: {
      'Cookie': `session_token=${token}`
    }
  });
  
  if (response.ok) {
    reports = await response.json();
    
    // Calcular estadísticas
    reports.forEach((report: Report) => {
      stats.total++;
      stats.bySector[report.sector as keyof typeof stats.bySector]++;
      stats.byStatus[report.status as keyof typeof stats.byStatus]++;
      stats.byPriority[report.priority as keyof typeof stats.byPriority]++;
      
      if (report.status === 'pendiente') stats.pendientes++;
      if (report.status === 'resuelto') stats.resueltos++;
    });
  }
} catch (err) {
  console.error('Error al obtener reportes:', err);
}

const recentReports = [...reports]
  .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())
  .slice(0, 5);


const sectorDataJson = JSON.stringify({
  labels: ['Primaria', 'Secundaria', 'Bachillerato', 'Universidad'],
  datasets: [{
    label: 'Reportes',
    data: [
      stats.bySector.primaria,
      stats.bySector.secundaria,
      stats.bySector.bachillerato,
      stats.bySector.universidad
    ],
    backgroundColor: [
      'rgba(59, 130, 246, 0.7)',
      'rgba(16, 185, 129, 0.7)',
      'rgba(245, 158, 11, 0.7)',
      'rgba(239, 68, 68, 0.7)'
    ]
  }]
});

const statusDataJson = JSON.stringify({
  labels: ['Pendientes', 'Resueltos'],
  datasets: [{
    data: [
      stats.byStatus.pendiente,
      stats.byStatus.resuelto
    ],
    backgroundColor: [
      'rgba(245, 158, 11, 0.7)',
      'rgba(16, 185, 129, 0.7)'
    ]
  }]
});

const priorityDataJson = JSON.stringify({
  labels: ['Media', 'Alta', 'Baja'],
  datasets: [{
    data: [
      stats.byPriority.media,
      stats.byPriority.alta,
      stats.byPriority.baja
    ],
    backgroundColor: [
      'rgba(245, 158, 11, 0.7)',
      'rgba(249, 115, 22, 0.7)',
      'rgba(156, 163, 175, 0.7)',
      'rgba(239, 68, 68, 0.7)'
    ]
  }]
});

const reportsJson = JSON.stringify(reports);
---

<Layout user={user}>
  <div class="flex h-screen w-screen">
    <main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-6 lg:p-8">
      <div class="mb-6 animate-slide-in-right">
        <h1 class="text-2xl font-bold text-gray-900">Bienvenido {user?.fullName || "Super Admin"}</h1>
      </div>

      <!-- seccion todos los sectores -->
      {(user?.role === 'tecnico' || user?.role === 'superadmin') && (
      <div class="mb-8">
        <select name="" id="sectorFilter" onchange="filterDashboardBySector()" class="bg-gray-200 rounded-md px-3 py-2 text-sm w-48 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-4">
          <option value="todos">Todos los Sectores</option>
          <option value="primaria">Primaria</option>
          <option value="secundaria">Secundaria</option>
          <option value="bachillerato">Bachillerato</option>
          <option value="universidad">Universidad</option>
        </select>
        <div class="flex gap-6 ">
          <div id="totalReports" class="bg-white flex items-center gap-x-14 rounded-xl shadow px-7 py-6 text-center animate-fade-in-up animation-delay-100 opacity-0">
            <div>
              <h3 class="text-xs font-medium text-gray-500 mb-1">
                {user?.role === 'tecnico' ? 'Mis Reportes' : 'Total de Reportes'}
              </h3>
              <p class="text-2xl md:text-3xl font-bold">{stats.total}</p>
            </div>
              <div class="bg-blue-100 rounded-md p-3">
                <Report class="w-6 h-6 text-blue-600"/>
              </div>
          </div>
          <div id="pendingReports" class="bg-white flex items-center gap-x-14 rounded-xl shadow px-7 py-6 text-center animate-fade-in-up animation-delay-200 opacity-0">
            <div>
              <h3 class="text-xs font-medium text-gray-500 mb-1">
                {user?.role === 'tecnico' ? 'Mis reportes pendientes' : 'Pendientes'}
              </h3>
              <p class="text-2xl md:text-3xl font-bold text-orange-600">{stats.pendientes}</p>
            </div>
              <div class="bg-orange-100 rounded-md p-3">
                <Clock class="w-6 h-6 text-orange-600"/>
              </div>
          </div>
          <div id="resolvedReports" class="bg-white flex items-center gap-x-14 rounded-xl shadow px-7 py-6  text-center animate-fade-in-up animation-delay-100 opacity-0">
            <div>
              <h3 class="text-xs font-medium text-gray-500 mb-1">
                {user?.role === 'tecnico' ? 'Mis reportes resueltos' : 'Resueltos'}
              </h3>
              <p class="text-2xl md:text-3xl font-bold text-green-600">{stats.resueltos}</p>
            </div>
              <div class="bg-green-100 rounded-md p-3">
                <Check class="w-6 h-6 text-green-600"/>
              </div>
          </div>
        </div>
      </div>
      )}
      
      <!-- Seccion graficas y reportes recientes -->
      <div class="grid grid-cols-4 gap-6">
        <div class="lg:col-span-2 space-y-6">
          <div class="bg-white rounded-xl shadow p-5 animate-scale-in animation-delay-400 opacity-0">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Reportes por Sector</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="text-sm font-medium text-gray-600">Primaria</span>
                <span id="primariaCount" class="text-lg font-bold text-blue-600">{stats.bySector.primaria}</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="text-sm font-medium text-gray-600">Secundaria</span>
                <span id="secundariaCount" class="text-lg font-bold text-green-600">{stats.bySector.secundaria}</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="text-sm font-medium text-gray-600">Bachillerato</span>
                <span id="bachilleratoCount"  class="text-lg font-bold text-yellow-600">{stats.bySector.bachillerato}</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="text-sm font-medium text-gray-600">Universidad</span>
                <span id="universidadCount" class="text-lg font-bold text-red-600">{stats.bySector.universidad}</span>
              </div>
            </div>
            <div class="h-48" 
                 data-sector-data={sectorDataJson}
                 id="sectorChartContainer">
              <canvas id="sectorChart"></canvas>
            </div>
          </div>
          
          <!-- Gráfica de Prioridad -->
          <div class="bg-white rounded-xl shadow p-5 animate-scale-in animation-delay-500 opacity-0">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Prioridad de Reportes</h2>
            <div class="h-48" 
                 data-priority-data={priorityDataJson}
                 id="priorityChartContainer">
              <canvas id="priorityChart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Estado de reportes recientes -->
        <div class="space-y-6 lg:col-span-2">
          <div class="bg-white rounded-xl shadow p-5 animate-scale-in animation-delay-600 opacity-0">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Estado de Reportes</h2>
            <div class="h-40 mb-4" 
                 data-status-data={statusDataJson}
                 id="statusChartContainer">
              <canvas id="statusChart"></canvas>
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                  <span class="text-sm text-gray-600">Pendientes</span>
                </div>
                <span id="pendingPercentage" class="font-bold text-lg">
                  {stats.total > 0 ? Math.round((stats.byStatus.pendiente / stats.total) * 100) : 0}%
                </span>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                  <span class="text-sm text-gray-600">Resueltos</span>
                </div>
                <span id="resolvedPercentage" class="font-bold text-lg">
                  {stats.total > 0 ? Math.round((stats.byStatus.resuelto / stats.total) * 100) : 0}%
                </span>
              </div>
            </div>
          </div>
          
          <!-- Reportes Recientes -->
          <div class="bg-white rounded-xl shadow p-5 animate-fade-in-up animation-delay-700 opacity-0">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Reportes Recientes</h2>
            <div id="recentReportsContainer" class="space-y-4 max-h-80 overflow-y-auto pr-2">
              {recentReports.length > 0 ? recentReports.map((report) => (
                <div class="border-b border-gray-100 pb-4 last:border-0 hover:bg-gray-50 p-2 rounded transition-colors">
                  <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                      <h4 class="font-medium text-gray-900 text-sm mb-1">
                        {report.description.length > 60 ? report.description.substring(0, 60) + '...' : report.description}
                      </h4>
                      <div class="flex items-center space-x-2">
                        <span class="text-xs font-medium text-gray-600 uppercase">{report.sector}</span>
                        <span class={`text-xs px-2 py-1 rounded-full font-medium ${
                          report.priority === 'alta' ? 'bg-orange-100 text-orange-800 border border-orange-200' :
                          report.priority === 'media' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                          'bg-gray-100 text-gray-800 border border-gray-200'
                        }`}>
                           {report.priority === 'alta' ? 'Alta' :
                           report.priority === 'media' ? 'Media' : 'Baja'}
                        </span>
                      </div>
                    </div>
                    <span class={`text-xs px-2 py-1 rounded-full font-medium ${
                      report.status === 'pendiente' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                      report.status === 'en_proceso' ? 'bg-blue-100 text-blue-800 border border-blue-200' :
                      'bg-green-100 text-green-800 border border-green-200'
                    }`}>
                      {report.status === 'pendiente' ? 'Pendiente' :
                       report.status === 'en_proceso' ? 'En Proceso' : 'Resuelto'}
                    </span>
                  </div>
                  <div class="text-xs text-gray-500 flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <span>Aula {report.classroom}</span>
                    <span class="mx-2">•</span>
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span>{new Date(report.created_at).toLocaleDateString()}</span>
                  </div>
                </div>
              )) : (
                <div class="text-center py-8 text-gray-500">
                  <svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  <p class="mt-2">No hay reportes recientes</p>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </main>
    <div id="reportsData" data-reports={reportsJson} style="display: none;"></div>
  </div>
  
   <script is:inline>
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    document.querySelectorAll('.opacity-0').forEach(el => {
      el.classList.remove('opacity-0');
    });
  }, 50);
});

document.addEventListener('astro:page-load', function() {
  setTimeout(() => {
    document.querySelectorAll('.opacity-0').forEach(el => {
      el.classList.remove('opacity-0');
    });
  }, 50);
});
</script>

  <script is:inline>
    if (typeof Chart === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
      script.onload = initCharts;
      document.head.appendChild(script);
    } else {
      document.addEventListener('DOMContentLoaded', initCharts);
    }
    
    function initCharts() {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js no esta disponible');
        return;
      }
      
      const sectorContainer = document.getElementById('sectorChartContainer');
      const statusContainer = document.getElementById('statusChartContainer');
      const priorityContainer = document.getElementById('priorityChartContainer');
      

      const sectorData = sectorContainer ? JSON.parse(sectorContainer.dataset.sectorData) : null;
      const statusData = statusContainer ? JSON.parse(statusContainer.dataset.statusData) : null;
      const priorityData = priorityContainer ? JSON.parse(priorityContainer.dataset.priorityData) : null;
      
      try {
        // Gráfica de barras para sectores
        const sectorCtx = document.getElementById('sectorChart');
        if (sectorCtx && sectorData) {
          new Chart(sectorCtx, {
            type: 'bar',
            data: sectorData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { stepSize: 1 }
                }
              }
            }
          });
        }
        
        // Gráfica de dona para estado
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx && statusData) {
          new Chart(statusCtx, {
            type: 'doughnut',
            data: statusData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { 
                legend: { 
                  display: false 
                } 
              },
              cutout: '70%'
            }
          });
        }
        
        // Gráfica de pastel para prioridad
        const priorityCtx = document.getElementById('priorityChart');
        if (priorityCtx && priorityData) {
          new Chart(priorityCtx, {
            type: 'pie',
            data: priorityData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { 
                legend: { 
                  position: 'bottom',
                  labels: {
                    padding: 15,
                    usePointStyle: true
                  }
                } 
              }
            }
          });
        }
      } catch (error) {
        console.error('Error al inicializar gráficas:', error);
      }
    }
  </script>

<script is:inline>
const reportsDataElement = document.getElementById('reportsData');
const originalReports = reportsDataElement ? JSON.parse(reportsDataElement.dataset.reports) : [];
let currentSector = 'todos';


function filterDashboardBySector() {
  const select = document.getElementById('sectorFilter');
  const sector = select.value;
  currentSector = sector;
  

  document.querySelectorAll('.bg-white').forEach(el => {
    el.classList.add('opacity-50');
  });
  

  let filteredReports = originalReports;
  if (sector !== 'todos') {
    filteredReports = originalReports.filter(report => report.sector === sector);
  }
  

  const newStats = calculateStats(filteredReports);

  updateDashboardUI(newStats, filteredReports);

  updateCharts(newStats);
  

  setTimeout(() => {
    document.querySelectorAll('.bg-white').forEach(el => {
      el.classList.remove('opacity-50');
    });
  }, 300);
}

function calculateStats(reports) {
  const stats = {
    total: 0,
    pendientes: 0,
    resueltos: 0,
    bySector: {
      primaria: 0,
      secundaria: 0,
      bachillerato: 0,
      universidad: 0
    },
    byStatus: {
      pendiente: 0,
      en_proceso: 0,
      resuelto: 0
    },
    byPriority: {
      alta: 0,
      media: 0,
      baja: 0
    }
  };
  
  reports.forEach(report => {
    stats.total++;
    stats.bySector[report.sector]++;
    stats.byStatus[report.status]++;
    stats.byPriority[report.priority]++;
    
    if (report.status === 'pendiente') stats.pendientes++;
    if (report.status === 'resuelto') stats.resueltos++;
  });
  
  return stats;
}

function updateDashboardUI(stats, reports) {
 
  document.getElementById('totalReports').querySelector('.text-2xl').textContent = stats.total;
  document.getElementById('pendingReports').querySelector('.text-2xl').textContent = stats.pendientes;
  document.getElementById('resolvedReports').querySelector('.text-2xl').textContent = stats.resueltos;
  

  document.getElementById('primariaCount').textContent = stats.bySector.primaria;
  document.getElementById('secundariaCount').textContent = stats.bySector.secundaria;
  document.getElementById('bachilleratoCount').textContent = stats.bySector.bachillerato;
  document.getElementById('universidadCount').textContent = stats.bySector.universidad;

  const pendingPercent = stats.total > 0 ? Math.round((stats.byStatus.pendiente / stats.total) * 100) : 0;
  const resolvedPercent = stats.total > 0 ? Math.round((stats.byStatus.resuelto / stats.total) * 100) : 0;
  
  document.getElementById('pendingPercentage').textContent = `${pendingPercent}%`;
  document.getElementById('resolvedPercentage').textContent = `${resolvedPercent}%`;

  updateRecentReports(reports.slice(0, 5));
}


function updateRecentReports(recentReports) {
  const container = document.getElementById('recentReportsContainer');
  
  if (recentReports.length === 0) {
    container.innerHTML = `
      <div class="text-center py-8 text-gray-500">
        <svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <p class="mt-2">No hay reportes recientes</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  recentReports.forEach((report, index) => {
    html += `
      <div class="border-b border-gray-100 pb-4 last:border-0 hover:bg-gray-50 p-2 rounded transition-colors animate-fade-in-up opacity-0"
           style="animation-delay: ${0.1 * index}s">
        <div class="flex justify-between items-start mb-2">
          <div class="flex-1">
            <h4 class="font-medium text-gray-900 text-sm mb-1">
              ${report.description.length > 60 ? report.description.substring(0, 60) + '...' : report.description}
            </h4>
            <div class="flex items-center space-x-2">
              <span class="text-xs font-medium text-gray-600 uppercase">${report.sector}</span>
              <span class="text-xs px-2 py-1 rounded-full font-medium ${getPriorityClass(report.priority)}">
                ${getPriorityText(report.priority)}
              </span>
            </div>
          </div>
          <span class="text-xs px-2 py-1 rounded-full font-medium ${getStatusClass(report.status)}">
            ${getStatusText(report.status)}
          </span>
        </div>
        <div class="text-xs text-gray-500 flex items-center">
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
          <span>Aula ${report.classroom}</span>
          <span class="mx-2">•</span>
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <span>${new Date(report.created_at).toLocaleDateString()}</span>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  
  setTimeout(() => {
    container.querySelectorAll('.opacity-0').forEach(el => {
      el.classList.remove('opacity-0');
    });
  }, 50);
}


function getPriorityClass(priority) {
  const classes = {
    'alta': 'bg-orange-100 text-orange-800 border border-orange-200',
    'media': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
    'baja': 'bg-gray-100 text-gray-800 border border-gray-200'
  };
  return classes[priority] || classes['baja'];
}

function getPriorityText(priority) {
  const texts = {
    'alta': 'Alta',
    'media': 'Media',
    'baja': 'Baja'
  };
  return texts[priority] || 'Baja';
}

function getStatusClass(status) {
  const classes = {
    'pendiente': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
    'en_proceso': 'bg-blue-100 text-blue-800 border border-blue-200',
    'resuelto': 'bg-green-100 text-green-800 border border-green-200'
  };
  return classes[status] || classes['pendiente'];
}

function getStatusText(status) {
  const texts = {
    'pendiente': 'Pendiente',
    'en_proceso': 'En Proceso',
    'resuelto': 'Resuelto'
  };
  return texts[status] || 'Pendiente';
}


function updateCharts(stats) {

  const charts = ['sectorChart', 'statusChart', 'priorityChart'];
  charts.forEach(chartId => {
    const chart = Chart.getChart(chartId);
    if (chart) chart.destroy();
  });
  

    const sectorData = {
    labels: ['Primaria', 'Secundaria', 'Bachillerato', 'Universidad'],
    datasets: [{
      label: 'Reportes',
      data: [
        stats.bySector.primaria,
        stats.bySector.secundaria,
        stats.bySector.bachillerato,
        stats.bySector.universidad
      ],
      backgroundColor: [
        'rgba(59, 130, 246, 0.7)',
        'rgba(16, 185, 129, 0.7)',
        'rgba(245, 158, 11, 0.7)',
        'rgba(239, 68, 68, 0.7)'
      ],
      borderWidth: 1,
      borderColor: [
        'rgba(59, 130, 246, 1)',
        'rgba(16, 185, 129, 1)',
        'rgba(245, 158, 11, 1)',
        'rgba(239, 68, 68, 1)'
      ],
      borderRadius: 8,
      barPercentage: 0.6
    }]
  };
  
  const statusData = {
    labels: ['Pendientes', 'Resueltos'],
    datasets: [{
      data: [stats.byStatus.pendiente, stats.byStatus.resuelto],
      backgroundColor: [
        'rgba(245, 158, 11, 0.7)',
        'rgba(16, 185, 129, 0.7)'
      ],
      borderWidth: 2,
      borderColor: [
        'rgba(245, 158, 11, 1)',
        'rgba(16, 185, 129, 1)'
      ]
    }]
  };
  
  const priorityData = {
    labels: ['Media', 'Alta', 'Baja'],
    datasets: [{
      data: [
        stats.byPriority.media,
        stats.byPriority.alta,
        stats.byPriority.baja
      ],
      backgroundColor: [
        'rgba(245, 158, 11, 0.7)',
        'rgba(249, 115, 22, 0.7)',
        'rgba(156, 163, 175, 0.7)',
        'rgba(239, 68, 68, 0.7)'
      ],
      borderWidth: 2,
      borderColor: [
        'rgba(245, 158, 11, 1)',
        'rgba(249, 115, 22, 1)',
        'rgba(156, 163, 175, 1)',
        'rgba(239, 68, 68, 1)'
      ]
    }]
  };
  

  animateCounter('totalReports', stats.total);
  animateCounter('pendingReports', stats.pendientes);
  animateCounter('resolvedReports', stats.resueltos);
  
  animateCounterValue('primariaCount', stats.bySector.primaria);
  animateCounterValue('secundariaCount', stats.bySector.secundaria);
  animateCounterValue('bachilleratoCount', stats.bySector.bachillerato);
  animateCounterValue('universidadCount', stats.bySector.universidad);
  

  updateChartWithAnimation('sectorChart', 'bar', sectorData, {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { display: false },
      tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.7)',
        padding: 10,
        cornerRadius: 6
      }
    },
    scales: {
      y: { 
        beginAtZero: true,
        ticks: { 
          stepSize: 1,
          callback: function(value) {
            if (value % 1 === 0) return value;
          }
        },
        grid: {
          drawBorder: false
        }
      },
      x: {
        grid: {
          display: false
        }
      }
    },
    animation: {
      duration: 1000,
      easing: 'easeOutQuart'
    },
    transitions: {
      active: {
        animation: {
          duration: 500
        }
      }
    }
  });
  
  updateChartWithAnimation('statusChart', 'doughnut', statusData, {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { 
        display: false 
      },
      tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.7)',
        padding: 10,
        cornerRadius: 6
      }
    },
    cutout: '70%',
    animation: {
      duration: 1000,
      easing: 'easeOutQuart',
      animateScale: true,
      animateRotate: true
    }
  });
  
  updateChartWithAnimation('priorityChart', 'pie', priorityData, {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { 
        position: 'bottom',
        labels: { 
          padding: 15,
          usePointStyle: true,
          font: {
            size: 11
          }
        }
      },
      tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.7)',
        padding: 10,
        cornerRadius: 6
      }
    },
    animation: {
      duration: 1000,
      easing: 'easeOutQuart',
      animateScale: true,
      animateRotate: true
    }
  });
}


function updateChartWithAnimation(chartId, type, data, options) {
  const ctx = document.getElementById(chartId);
  if (!ctx) return;
  
  const existingChart = Chart.getChart(chartId);
  
  if (existingChart) {
    
    existingChart.data = data;
    existingChart.options = options;
    existingChart.update('active');
  } else {
    new Chart(ctx, {
      type: type,
      data: data,
      options: options
    });
  }
}

function animateCounter(elementId, targetValue) {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  const counterElement = element.querySelector('.text-2xl');
  if (!counterElement) return;
  
  animateValue(counterElement, parseInt(counterElement.textContent), targetValue, 800);
}

function animateCounterValue(elementId, targetValue) {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  const currentValue = parseInt(element.textContent);
  if (currentValue === targetValue) return;
  
  animateValue(element, currentValue, targetValue, 800);
}

function animateValue(element, start, end, duration) {
  const startTimestamp = performance.now();
  
  function step(timestamp) {
    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
    const current = Math.floor(progress * (end - start) + start);
    element.textContent = current;
    
    if (progress < 1) {
      requestAnimationFrame(step);
    }
  }
  
  requestAnimationFrame(step);
}
</script>
</Layout>

<style>

  canvas {
    max-width: 100% !important;
  }
  

  .max-h-80::-webkit-scrollbar {
    width: 6px;
  }
  
  .max-h-80::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }
  
  .max-h-80::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
  }
  
  .max-h-80::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
</style>