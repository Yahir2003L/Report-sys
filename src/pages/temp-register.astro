---
// src/pages/temp-register.astro
import { pool } from '../lib/db';
import mysql from 'mysql2'
import bcrypt from 'bcrypt';

// Verificar si ya existe un superadmin
const [existingAdmin] = await pool.query<mysql.RowDataPacket[]>(
  "SELECT id FROM users WHERE role = 'superadmin' LIMIT 1"
);

let message = '';
let showForm = true;

if (existingAdmin.length > 0) {
  showForm = false;
  message = '❌ Ya existe un superadmin en el sistema';
}

// Procesar el formulario
if (Astro.request.method === 'POST' && showForm) {
  const formData = await Astro.request.formData();
  const username = formData.get('username')?.toString() || '';
  const password = formData.get('password')?.toString() || '';
  const fullName = formData.get('full_name')?.toString() || '';

  try {
    const hashedPassword = await bcrypt.hash(password, 10);
    
    await pool.query(
      `INSERT INTO users SET ?`,
      {
        username,
        password: hashedPassword,
        full_name: fullName,
        role: 'superadmin',
        sector: 'universidad',
        created_by: null,
        created_at: new Date(),
        is_active: true
      }
    );
    
    message = '✅ Superadmin creado exitosamente';
    showForm = false;
  } catch (error) {
    message = `❌ Error: ${error instanceof Error ? error.message : 'Error desconocido'}`;
  }
}
---

<!-- Resto del template HTML igual que antes -->
<html lang="es">
<head>
  <title>Registro Temporal de Superadmin</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.5rem; }
    input { width: 100%; padding: 0.5rem; }
    button { background: #2563eb; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Registro Temporal de Superadmin</h1>
  
  {message && <p style={message.includes('✅') ? 'color: green;' : 'color: red;'}>{message}</p>}

  {showForm && (
    <form method="POST">
      <div class="form-group">
        <label for="username">Nombre de usuario:</label>
        <input type="text" id="username" name="username" required>
      </div>
      
      <div class="form-group">
        <label for="password">Contraseña:</label>
        <input type="password" id="password" name="password" required>
      </div>
      
      <div class="form-group">
        <label for="full_name">Nombre completo:</label>
        <input type="text" id="full_name" name="full_name" required>
      </div>
      
      <button type="submit">Crear Superadmin</button>
    </form>
  )}
  
  <p><small>Esta página solo debe estar disponible en entorno de desarrollo.</small></p>
</body>
</html>