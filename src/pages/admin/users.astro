---
import Layout from '@/layouts/Layout.astro';
import { getUserFromToken } from '@/lib/auth';
import { isSuperadmin } from '@/lib/access-control';
import { pool } from '@/lib/db';
import mysql from 'mysql2/promise';
import EditUserModal from '@/components/EditUserModal.astro';
import CreateUserModal from '@/components/CreateUserModal.astro';

interface User {
  id: number;
  username: string;
  full_name: string;
  role: string;
  sector: string;
  is_active: boolean;
  created_at: string;
  created_by_name?: string;
}

const token = Astro.cookies.get('session_token')?.value;
const currentUser = await getUserFromToken(token || "");

if (!currentUser || !isSuperadmin(currentUser)) {
  return Astro.redirect('/login');
}

async function getAllUsers(): Promise<User[]> {
  const [rows] = await pool.query<mysql.RowDataPacket[]>(`
    SELECT 
      id, 
      username, 
      full_name, 
      role, 
      sector, 
      is_active,
      DATE_FORMAT(created_at, '%d/%m/%Y') as created_at,
      (SELECT username FROM users WHERE id = u.created_by) as created_by_name
    FROM users u
    ORDER BY is_active DESC, role DESC, created_at DESC
  `);
  
  return rows.map(row => ({
    ...row,
    is_active: Boolean(row.is_active)
  })) as User[];
}

const users = await getAllUsers();

const getRoleBadgeColor = (role: string) => {
  switch(role.toLowerCase()) {
    case 'superadmin': return 'bg-purple-100 text-purple-700 border-purple-200';
    case 'tecnico': return 'bg-amber-100 text-amber-800 border-amber-200';
    default: return 'bg-blue-50 text-blue-700 border-blue-200';
  }
};
---

<Layout title="Gestión de Usuarios" user={currentUser} token={token}>
  <main class="w-full h-screen overflow-y-auto py-8 px-8 bg-slate-50">
    
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8 gap-4 w-full">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          Gestión de Usuarios
        </h1>
        <p class="text-gray-600">
          Administra los usuarios, roles y accesos del sistema
        </p>
      </div>
      
      {currentUser?.role === 'superadmin' && (
        <div class="relative">
            <CreateUserModal user={currentUser} />
        </div>
      )}
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-8 w-full">
      <div class="relative">
        <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-1/2 -translate-y-1/2 size-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          id="search-input"
          type="text"
          placeholder="Buscar usuarios por nombre, usuario o rol..."
          class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-800 focus:border-transparent transition-all"
        />
      </div>
    </div>

    <div class="space-y-4 w-full" id="users-list">
      {users.length === 0 ? (
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-12 text-center w-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0zm1.66-9H21l-1.66 1.66L21 16l-1.66 1.66L21 20h-4.34"/>
            </svg>
          <p class="text-gray-500">No se encontraron usuarios</p>
        </div>
      ) : (
        users.map(user => (
          <div 
            id={`user-row-${user.id}`} 
            class="user-card bg-white rounded-xl shadow-sm border border-slate-200 p-6 transition-all hover:shadow-md w-full"
            data-search={`${user.full_name} ${user.username} ${user.role} ${user.sector}`}
          >
            <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
              
              <div class="flex items-start gap-5 w-full lg:w-auto">
                <div class="relative shrink-0">
                  <div class="w-14 h-14 bg-gray-100 rounded-full flex items-center justify-center border border-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                    </svg>
                  </div>
                  <span class={`absolute bottom-0 right-0 w-4 h-4 border-2 border-white rounded-full ${user.is_active ? 'bg-green-500' : 'bg-red-500'}`} title={user.is_active ? 'Activo' : 'Inactivo'}></span>
                </div>

                <div class="flex-1 min-w-0">
                  <div class="flex items-center flex-wrap gap-3 mb-1.5">
                    <h3 class="font-bold text-gray-900 text-lg">{user.full_name}</h3>
                    <span class={`px-2.5 py-0.5 rounded-full text-xs font-bold border ${getRoleBadgeColor(user.role)} uppercase tracking-wide`}>
                      {user.role}
                    </span>
                  </div>
                  
                  <div class="space-y-1">
                    <p class="text-sm font-medium text-gray-500">@{user.username}</p>
                    {user.sector && (
                       <p class="text-sm text-gray-500 flex items-center gap-1">
                          <span class="text-gray-400">Sector:</span> <span class="capitalize font-medium text-gray-700">{user.sector}</span>
                       </p>
                    )}
                  </div>
                </div>
              </div>

              <div class="flex flex-col lg:items-end gap-4 w-full lg:w-auto pl-0 lg:pl-0">
                 <div class="hidden lg:flex items-center gap-4 text-xs text-gray-400 mb-1">
                    <span class="flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        Creado por: <span class="font-medium text-gray-600">{user.created_by_name || 'Sistema'}</span>
                    </span>
                    <span class="flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        {user.created_at}
                    </span>
                 </div>

                <div class="flex items-center gap-3 w-full sm:w-auto">
                    <button
                      class="flex-1 sm:flex-none inline-flex justify-center items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-slate-900 transition-colors shadow-sm"
                      hx-get={`/modals/edit-user?id=${user.id}`}
                      hx-target="#editModalContent"
                      hx-trigger="click"
                      onclick="document.getElementById('editModal').classList.remove('hidden')"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                      Editar
                    </button>

                    {user.is_active ? (
                      <button
                        class="flex-1 sm:flex-none inline-flex justify-center items-center gap-2 px-4 py-2 bg-white border border-red-200 rounded-lg text-sm font-medium text-red-600 hover:bg-red-50 transition-colors shadow-sm"
                        hx-delete={`/api/users/${user.id}`}
                        hx-target={`#user-row-${user.id}`}
                        hx-confirm="¿Desactivar este usuario?"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                        Desactivar
                      </button>
                    ) : (
                      <button
                        class="flex-1 sm:flex-none inline-flex justify-center items-center gap-2 px-4 py-2 bg-white border border-green-200 rounded-lg text-sm font-medium text-green-600 hover:bg-green-50 transition-colors shadow-sm"
                        hx-post={`/api/users/${user.id}`}
                        hx-target={`#user-row-${user.id}`}
                        hx-confirm="¿Seguro que quieres activar este usuario?"
                      >
                         <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        Activar
                      </button>
                    )}
                </div>
              </div>

            </div>
          </div>
        ))
      )}
    </div>
    
    <div id="editModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-all">
      <div id="editModalContent" class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        </div>
    </div>

    <div id="loading-indicator" class="fixed top-0 left-0 right-0 h-1 bg-slate-800 opacity-0 transition-opacity duration-300 z-50"></div>
  </main>

  <script src="https://unpkg.com/htmx.org@1.9.6"></script>
  <script is:inline>
    const searchInput = document.getElementById('search-input');
    const userCards = document.querySelectorAll('.user-card');

    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            userCards.forEach(card => {
                const searchData = card.getAttribute('data-search').toLowerCase();
                if (searchData.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }

    document.addEventListener('click', (e) => {
      if (e.target.id === 'editModal' || e.target.closest('[data-modal-close]')) {
        document.getElementById('editModal').classList.add('hidden');
      }
    });

    document.body.addEventListener('htmx:afterOnLoad', (evt) => {
      if (evt.detail.successful && evt.detail.requestConfig.verb === 'put') {
        document.getElementById('editModal').classList.add('hidden');
      }
    });

    document.body.addEventListener('htmx:beforeRequest', () => {
      document.getElementById('loading-indicator').classList.remove('opacity-0');
    });
    document.body.addEventListener('htmx:afterRequest', () => {
      document.getElementById('loading-indicator').classList.add('opacity-0');
    });
  </script>
</Layout>