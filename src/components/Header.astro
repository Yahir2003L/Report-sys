---
import { logout } from '../lib/auth';
import Settings from './icons/Settings.astro';
import User from './icons/User.astro';
import Logout from './icons/Logout.astro';
import UsersIcon from './icons/Users.astro';

type Sector = 'primaria' | 'secundaria' | 'bachillerato' | 'universidad';

interface Props {
  user: {
    userId: number;
    username: string;
    fullName: string;
    role: 'superadmin' | 'admin' | 'user';
    sector: 'primaria' | 'secundaria' | 'bachillerato' | 'universidad';
  } | null | undefined;
  token?: string;
  currentSector: 'primaria' | 'secundaria' | 'bachillerato' | 'universidad';
}

const { user, token, currentSector } = Astro.props;
const sectors = ['primaria', 'secundaria', 'bachillerato', 'universidad'];
const sectorNames ={
  primaria: 'primaria',
  secundaria: 'secundaria',
  bachillerato: 'bachillerato',
  universidad: 'universidad',
};
---
<script src="https://unpkg.com/alpinejs" defer></script>

<header>
  <div class="flex justify-between items-center py-3 px-10 relative">
    <a href="/">
      <div class="logo">Rolando</div>
    </a>
      <ul class="nav-left flex items-center bg-[#1F1F23] px-5 py-1 rounded-full gap-x-5">
      {sectors.map(sector => (
  <li 
    class={`px-3 py-2 cursor-pointer rounded-full transition-colors ${
      currentSector === sector 
        ? 'text-black bg-yellow-300' 
        : 'text-gray-400 hover:text-gray-300'
    }`}
    onclick={`handleSectorClick('${sector as Sector}')`}
  >
    {sectorNames[sector as Sector]}
  </li>
))}
    </ul>
    <ul class="nav-right flex justify-center items-center gap-x-2 relative" x-data="{ open: false }">
      {user?.role === 'superadmin' && (
        <li class="w-10 h-10 bg-slate-200 rounded-full flex justify-center items-center cursor-pointer">
          <a href="/admin/users" title="Gestión de usuarios">
            <UsersIcon class="w-5" />
          </a>
        </li>
      )}
      <li @click="open = !open" class="w-10 h-10 bg-slate-200 rounded-full flex justify-center items-center cursor-pointer relative">
        <User class="w-5" />
        <!-- Dropdown -->
        <div x-show="open" @click.away="open = false" class="absolute top-12 right-0 bg-white rounded-md shadow-md py-2 w-40 z-50">
          <form method="POST" action="/api/logout" class="text-sm text-left px-4">
            <input type="hidden" name="token" value={Astro.cookies.get('session_token')?.value} />
            <button type="submit" class="w-full text-left py-2 rounded flex items-center gap-x-2 cursor-pointer">
              <Logout class="w-5" />
              Cerrar sesión
            </button>
          </form>
        </div>
      </li>
    </ul>
  </div>
</header>

<script is:inline>
  function handleSectorClick(sector) {
    const userRole = document.body.getAttribute('data-user-role');
    if (userRole === 'superadmin' || userRole === 'admin') {
      localStorage.setItem('selectedSector', sector);
      window.location.href = `/?sector=${sector}`;
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    const userRole = document.body.getAttribute('data-user-role');
    if (userRole === 'user') {
      document.querySelectorAll('.nav-left li').forEach(li => {
        li.style.pointerEvents = 'none';
      });
    }
  });
</script>

<!-- {user && (
  <div class="user-section">
    <form method="POST" action="/api/logout">
      <input type="hidden" name="token" value={Astro.cookies.get('session_token')?.value} />
      <button type="submit" class="btn btn-danger">Cerrar sesión</button>
    </form>
  </div>
)} -->