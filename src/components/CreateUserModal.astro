---
import { isSuperadmin } from '../lib/access-control';
import Create from './icons/Create.astro';
import Plus from './icons/Plus.astro';

interface Props {
  user: {
    userId: number;
    username: string;
    fullName: string;
    role: 'superadmin' | 'tecnico' | 'user';
    sector: 'primaria' | 'secundaria' | 'bachillerato' | 'universidad';
  } | null | undefined;
}

const { user } = Astro.props;
const isSuperAdmin = user ? isSuperadmin(user) : false;
---

{isSuperAdmin && (
  <>
    <button
      type="button"
      class="bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors flex items-center gap-x-2 cursor-pointer"
      onclick="document.getElementById('createUserModal').classList.remove('hidden')"
    >

    <Plus class="w-5 h-5" />
      Crear Usuario
    </button>

    {/* modal */}
    <div 
      id="createUserModal" 
      class="hidden fixed inset-0 z-50 overflow-y-auto"
      aria-labelledby="modal-title"
      aria-modal="true"
      role="dialog"
    >
      <div 
        class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
        onclick="document.getElementById('createUserModal').classList.add('hidden')"
      ></div>

      {/* contenido del modal */}
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
          <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold leading-6 text-gray-900">Crear Nuevo Usuario</h3>
              <button
                type="button"
                class="text-gray-400 hover:text-gray-500"
                onclick="document.getElementById('createUserModal').classList.add('hidden')"
              >
                <span class="sr-only">Cerrar</span>
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <form id="createUserForm" method="POST" action="/api/users" class="space-y-4">
              <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Nombre de usuario</label>
                <input 
                  type="text" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                  id="username" 
                  name="username" 
                  required 
                />
              </div>
              <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                <input 
                  type="password" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                  id="password" 
                  name="password" 
                  required 
                />
              </div>
              <div class="mb-4">
                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
                <input 
                  type="text" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                  id="fullName" 
                  name="fullName" 
                  required 
                />
              </div>
              <div class="mb-4">
                <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Rol</label>
                <select 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                  id="role" 
                  name="role" 
                  required
                >
                  <option value="tecnico">Administrador</option>
                  <option value="user">Usuario</option>
                </select>
              </div>
              <div class="mb-4">
                <label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Sector</label>
                <select 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                  id="sector" 
                  name="sector" 
                  required
                >
                  <option value="primaria">Primaria</option>
                  <option value="secundaria">Secundaria</option>
                  <option value="bachillerato">Bachillerato</option>
                  <option value="universidad">Universidad</option>
                </select>
              </div>
              <div class="flex justify-end space-x-3">
                <button 
                  type="button"
                  class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors"
                  onclick="document.getElementById('createUserModal').classList.add('hidden')"
                >
                  Cancelar
                </button>
                <button 
                  type="submit" 
                  class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                >
                  Crear Usuario
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </>
)}

<script is:inline>
  function ensureSwalLoaded() {
    return new Promise((resolve) => {
      if (window.Swal) return resolve(true);
      
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
      script.onload = () => resolve(true);
      script.onerror = () => {
        console.error('Error al cargar SweetAlert2');
        resolve(false);
      };
      document.head.appendChild(script);
    });
  }
  
  document.getElementById('createUserForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    try {
      const swalLoaded = await ensureSwalLoaded();
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Creando...';
      
      const response = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: { 'Accept': 'application/json' }
      });
      
      const result = await response.json();
      
      if (!response.ok) throw new Error(result.message || 'Error desconocido');
      
      if (swalLoaded) {
        await Swal.fire({
          icon: 'success',
          title: result.message || '¡Éxito!',
          showConfirmButton: false,
          timer: 2000
        });
      } else {
        alert(result.message || 'Usuario creado exitosamente');
      }
      
      form.reset();
      document.getElementById('createUserModal')?.classList.add('hidden');
      
    } catch (error) {
      if (window.Swal) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message,
          confirmButtonColor: '#3085d6'
        });
      } else {
        alert('Error: ' + error.message);
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Crear Usuario';
    }
  });
  </script>