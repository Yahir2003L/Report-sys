---
interface Props {
  reportId: number;
  currentTechnicianId: number;
  currentTechnicianName?: string;
  technicians: Array<{id: number, full_name: string}>;
}

const { reportId, currentTechnicianId, currentTechnicianName, technicians } = Astro.props;
---

<div id="reassignModal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-base" onclick="closeReassignModal()">
  <div class="modal-overlay fixed inset-0 bg-black/50"></div>
  <div class="flex min-h-full items-center justify-center p-4 relative z-50">
    <div class="relative modal-content bg-white rounded-lg shadow-xl w-full max-w-md" onclick="event.stopPropagation()">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-lg font-semibold text-gray-900">Reasignar Reporte</h3>
          <button
            onclick="closeReassignModal()"
            class="text-gray-400 hover:text-gray-500"
          >
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div class="mb-6">
          {currentTechnicianName && (
            <p class="text-sm text-gray-600">
              <span class="font-medium">Técnico actual:</span> {currentTechnicianName}
            </p>
          )}
        </div>

        <form id="reassignForm" method="PUT" class="space-y-4">
          <input type="hidden" id="reassignReportId" name="reportId" value={reportId} />
          
          <div>
            <label for="newTechnicianId" class="block text-sm font-medium text-gray-700 mb-2">
              Seleccionar nuevo técnico *
            </label>
            <select 
              id="newTechnicianId" 
              name="newTechnicianId"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              required
            >
              <option value="">-- Seleccionar técnico --</option>
              {technicians.map(tech => (
                <option 
                  value={tech.id} 
                  selected={tech.id === currentTechnicianId}
                >
                  {tech.full_name}
                </option>
              ))}
            </select>
          </div>

          <div class="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              onclick="closeReassignModal()"
              class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors"
            >
              Cancelar
            </button>
            <button
              type="submit"
              id="reassignSubmitBtn"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
            >
              Confirmar Reasignación
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  // Variables globales para el modal
  let currentReportForReassign = null;

  window.openReassignModal = function(reportId, currentTechnicianId, currentTechnicianName) {
    currentReportForReassign = { reportId, currentTechnicianId, currentTechnicianName };
    
    const modal = document.getElementById('reassignModal');
    if (!modal) return;
    
    // Actualizar valores del formulario
    document.getElementById('reassignReportId').value = reportId;
    const select = document.getElementById('newTechnicianId');
    if (select) {
      select.value = currentTechnicianId;
    }
    
    modal.classList.remove('hidden');
    
    requestAnimationFrame(() => {
      modal.classList.add('modal-open');
    });
  };

  window.closeReassignModal = function() {
    const modal = document.getElementById('reassignModal');
    if (!modal) return;
    
    modal.classList.remove('modal-open');
    
    setTimeout(() => {
      modal.classList.add('hidden');
      currentReportForReassign = null;
    }, 350);
  };

  // Manejar envío del formulario de reasignación
  document.addEventListener('DOMContentLoaded', function() {
    const reassignForm = document.getElementById('reassignForm');
    
    if (reassignForm) {
      reassignForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const reportId = document.getElementById('reassignReportId').value;
        const newTechnicianId = document.getElementById('newTechnicianId').value;
        
        if (!newTechnicianId) {
          alert('Por favor selecciona un técnico');
          return;
        }

        const submitBtn = document.getElementById('reassignSubmitBtn');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Reasignando...';

        try {
          const response = await fetch('/api/reports', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              reportId: parseInt(reportId),
              newTechnicianId: parseInt(newTechnicianId)
            })
          });

          if (response.ok) {
            const result = await response.json();
            alert(result.message || 'Reporte reasignado exitosamente');
            
            // Cerrar modal y recargar la página
            closeReassignModal();
            window.location.reload();
          } else {
            const error = await response.json();
            throw new Error(error.message || 'Error al reasignar el reporte');
          }
        } catch (error) {
          alert('Error: ' + error.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }
  });
</script>

<style is:global>
  .modal-open {
    opacity: 1;
    transform: scale(1);
  }

  .modal-base {
    opacity: 0;
    transition: opacity 0.35s ease;
  }

  .modal-base .modal-overlay {
    opacity: 0;
    transition: opacity 0.35s ease;
  }

  .modal-base .modal-content {
    transform: scale(0.96);
    opacity: 0;
    transition: transform 0.35s cubic-bezier(.2,.8,.2,1), opacity 0.25s ease;
  }

  .modal-base.modal-open {
    opacity: 1;
  }

  .modal-base.modal-open .modal-overlay {
    opacity: 1;
  }

  .modal-base.modal-open .modal-content {
    transform: scale(1);
    opacity: 1;
  }
</style>