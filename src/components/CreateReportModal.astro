---
import { isSuperadmin } from '../lib/access-control';
import Create from './icons/Create.astro';

interface Props {
  user: {
    userId: number;
    username: string;
    fullName: string;
    role: 'superadmin' | 'admin' | 'user';
    sector: 'primaria' | 'secundaria' | 'bachillerato' | 'universidad';
  } | null | undefined;
}

const { user } = Astro.props;
const isSuperAdmin = user ? isSuperadmin(user) : false;
---

<button
  type="button"
  class="px-4 py-2 flex items-center gap-x-2 bg-white border-gray-500 border-1 cursor-pointer text-sm text-black rounded-full font-semibold"
  onclick="document.getElementById('createReportModal').classList.remove('hidden')"
>
  <Create class="w-5"/>
  Crear Reporte
</button>

{/* Modal */}
<div 
  id="createReportModal" 
  class="hidden fixed inset-0 z-50 overflow-y-auto"
  aria-labelledby="modal-title"
  aria-modal="true"
  role="dialog"
>
  <div 
    class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
    onclick="document.getElementById('createReportModal').classList.add('hidden')"
  ></div>

  {/* Contenido del modal */}
  <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
    <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
      <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold leading-6 text-gray-900">Crear Nuevo Reporte</h3>
          <button
            type="button"
            class="text-gray-400 hover:text-gray-500"
            onclick="document.getElementById('createReportModal').classList.add('hidden')"
          >
            <span class="sr-only">Cerrar</span>
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <form id="createReportForm" method="POST" action="/api/reports" class="space-y-4">
          <div>
            <label for="classroom" class="block text-sm font-medium text-gray-700 mb-1">Aula</label>
            <input 
              type="text" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
              id="classroom" 
              name="classroom" 
              required 
            />
          </div>

          {user?.role !== 'user' && (
            <div>
              <label for="sector" class="block text-sm font-medium text-gray-700 mb-1">Sector</label>
              <select 
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                id="sector" 
                name="sector"
              >
                <option value="primaria">Primaria</option>
                <option value="secundaria">Secundaria</option>
                <option value="bachillerato">Bachillerato</option>
                <option value="universidad">Universidad</option>
              </select>
            </div>
          )}

          <div>
            <label for="problemType" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Problema</label>
            <select 
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
              id="problemType" 
              name="problemType" 
              required
            >
              <option value="red">Problema de Red</option>
              <option value="telefonico">Problema Telefónico</option>
              <option value="proyector">Problema con Proyector</option>
              <option value="pantalla">Problema con Pantalla</option>
              <option value="electrico">Problema Eléctrico</option>
              <option value="general">Problema General</option>
            </select>
          </div>

          <div>
            <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">Prioridad</label>
            <select 
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
              id="priority" 
              name="priority" 
              required
            >
              <option value="alta">Alta</option>
              <option value="media" selected>Media</option>
              <option value="baja">Baja</option>
            </select>
          </div>

          <div>
            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripción (Opcional)</label>
            <textarea 
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
              id="description" 
              name="description" 
              rows="3"
            ></textarea>
          </div>

          <div class="flex justify-end space-x-3">
            <button 
              type="button"
              class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors"
              onclick="document.getElementById('createReportModal').classList.add('hidden')"
            >
              Cancelar
            </button>
            <button 
              type="submit" 
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
            >
              Enviar Reporte
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  function ensureSwalLoaded() {
    return new Promise((resolve) => {
      if (window.Swal) return resolve(true);

      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
      script.onload = () => resolve(true);
      script.onerror = () => {
        console.error('Error al cargar SweetAlert2');
        resolve(false);
      };
      document.head.appendChild(script);
    });
  }

  document.getElementById('createReportForm')?.addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const classroom = form.classroom.value.trim();
    const sector = form.sector?.value || '${user?.sector}';
    const problemType = form.problemType.value;

    try {
      const swalLoaded = await ensureSwalLoaded();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enviando...';

      // Primero, validar duplicado
      const checkRes = await fetch('/api/reports', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ classroom, sector, problemType })
      });

      const checkResult = await checkRes.json();

      if (checkResult.exists) {
        const msg = `Ya existe un reporte activo para esta aula y tipo de problema.`;
        if (swalLoaded) {
          await Swal.fire({
            icon: 'error',
            title: 'Reporte Ya Existente',
            text: msg
          });
        } else {
          alert(msg);
        }
        return;
      }


      const response = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: { 'Accept': 'application/json' }
      });

      const result = await response.json();

      if (!response.ok) throw new Error(result.message || 'Error desconocido');

      if (swalLoaded) {
        await Swal.fire({
          icon: 'success',
          title: result.message || '¡Éxito!',
          showConfirmButton: false,
          timer: 2000
        });
      } else {
        alert(result.message || 'Reporte creado exitosamente');
      }

      form.reset();
      document.getElementById('createReportModal')?.classList.add('hidden');
      window.location.reload();

    } catch (error) {
      if (window.Swal) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message,
          confirmButtonColor: '#3085d6'
        });
      } else {
        alert('Error: ' + error.message);
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enviar Reporte';
    }
  });
</script>
